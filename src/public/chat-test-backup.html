<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Socket.IO Test Client - Chat & Jobs</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      /* CSS Reset */
      *,
      *::before,
      *::after {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      /* Base Styles */
      body {
        font-family:
          'Inter',
          -apple-system,
          BlinkMacSystemFont,
          'Segoe UI',
          sans-serif;
        background: oklch(0.14 0.01 264);
        min-height: 100vh;
        padding: 20px;
        line-height: 1.6;
        color: oklch(0.98 0 0);
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
      }

      /* Header */
      .page-header {
        background: oklch(0.45 0.15 264);
        color: oklch(0.98 0 0);
        padding: 32px;
        border-radius: 16px;
        margin-bottom: 24px;
        box-shadow: 0 8px 20px rgba(70, 90, 234, 0.3);
        border: 1px solid oklch(0.25 0.01 264);
      }

      .page-header h1 {
        font-size: 28px;
        font-weight: 700;
        margin-bottom: 8px;
        letter-spacing: -0.5px;
      }

      .page-header p {
        font-size: 14px;
        opacity: 0.9;
      }

      /* Section */
      .section {
        background: oklch(0.18 0.01 264);
        border-radius: 12px;
        padding: 24px;
        margin-bottom: 20px;
        border: 1px solid oklch(0.25 0.01 264);
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
      }

      .section-title {
        font-size: 18px;
        font-weight: 600;
        color: oklch(0.98 0 0);
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .section-icon {
        width: 20px;
        height: 20px;
        stroke: currentColor;
        stroke-width: 2;
        fill: none;
      }

      /* Form Elements */
      .form-group {
        margin-bottom: 16px;
      }

      .form-label {
        display: block;
        font-size: 14px;
        font-weight: 600;
        color: oklch(0.98 0 0);
        margin-bottom: 6px;
      }

      .form-input,
      .form-select {
        width: 100%;
        padding: 10px 14px;
        border: 1px solid oklch(0.25 0.01 264);
        border-radius: 8px;
        font-size: 14px;
        transition: all 0.2s;
        font-family: inherit;
        background: oklch(0.25 0.01 264);
        color: oklch(0.98 0 0);
      }

      .form-input:focus,
      .form-select:focus {
        outline: none;
        border-color: oklch(0.45 0.15 264);
        box-shadow: 0 0 0 3px rgba(70, 90, 234, 0.2);
      }

      /* Buttons */
      .btn {
        padding: 10px 20px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        border: none;
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }

      .btn-primary {
        background: oklch(0.45 0.15 264);
        color: oklch(0.98 0 0);
        border: 1px solid oklch(0.25 0.01 264);
      }

      .btn-primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(70, 90, 234, 0.4);
        background: oklch(0.5 0.15 264);
      }

      .btn-secondary {
        background: oklch(0.25 0.01 264);
        color: oklch(0.98 0 0);
        border: 1px solid oklch(0.25 0.01 264);
      }

      .btn-secondary:hover {
        background: oklch(0.55 0.22 25);
        border-color: oklch(0.55 0.22 25);
      }

      .btn-success {
        background: oklch(0.55 0.15 145);
        color: oklch(0.98 0 0);
      }

      .btn-success:hover {
        background: oklch(0.5 0.15 145);
      }

      .btn-small {
        padding: 6px 12px;
        font-size: 13px;
      }

      .btn-icon {
        width: 16px;
        height: 16px;
        stroke: currentColor;
        stroke-width: 2;
        fill: none;
      }

      /* Status */
      .status-box {
        padding: 16px;
        border-radius: 8px;
        font-size: 14px;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .status-success {
        background: oklch(0.25 0.01 264);
        color: oklch(0.55 0.15 145);
        border: 1px solid oklch(0.55 0.15 145);
      }

      .status-error {
        background: oklch(0.25 0.01 264);
        color: oklch(0.55 0.22 25);
        border: 1px solid oklch(0.55 0.22 25);
      }

      .status-icon {
        width: 20px;
        height: 20px;
        flex-shrink: 0;
      }

      .hidden {
        display: none !important;
      }

      /* Lists and Cards */
      .list-box {
        max-height: 400px;
        overflow-y: auto;
        border: 1px solid oklch(0.25 0.01 264);
        border-radius: 8px;
        padding: 16px;
        background: oklch(0.25 0.01 264);
        margin-top: 16px;
      }

      .list-box::-webkit-scrollbar {
        width: 8px;
      }

      .list-box::-webkit-scrollbar-track {
        background: oklch(0.18 0.01 264);
        border-radius: 4px;
      }

      .list-box::-webkit-scrollbar-thumb {
        background: oklch(0.45 0.15 264);
        border-radius: 4px;
      }

      .item-card {
        background: oklch(0.18 0.01 264);
        border: 1px solid oklch(0.25 0.01 264);
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 12px;
      }

      .item-card:last-child {
        margin-bottom: 0;
      }

      .item-title {
        font-size: 15px;
        font-weight: 600;
        color: oklch(0.98 0 0);
        margin-bottom: 8px;
      }

      .item-meta {
        font-size: 13px;
        color: oklch(0.65 0.01 264);
        margin-bottom: 8px;
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
      }

      .meta-item {
        display: flex;
        align-items: center;
        gap: 4px;
      }

      .meta-icon {
        width: 14px;
        height: 14px;
        stroke: currentColor;
        stroke-width: 2;
        fill: none;
      }

      .status-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
      }

      .badge-pending {
        background: oklch(0.25 0.02 264);
        color: #f59e0b;
        border: 1px solid #f59e0b;
      }

      .badge-accepted {
        background: oklch(0.25 0.02 264);
        color: oklch(0.55 0.15 145);
        border: 1px solid oklch(0.55 0.15 145);
      }

      .badge-rejected {
        background: oklch(0.25 0.02 264);
        color: oklch(0.55 0.22 25);
        border: 1px solid oklch(0.55 0.22 25);
      }

      .badge-viewed {
        background: oklch(0.25 0.02 264);
        color: oklch(0.55 0.12 220);
        border: 1px solid oklch(0.55 0.12 220);
      }

      /* Chat */
      .chat-box {
        height: 400px;
        overflow-y: auto;
        border: 1px solid oklch(0.25 0.01 264);
        border-radius: 8px;
        padding: 16px;
        background: oklch(0.25 0.01 264);
        margin: 16px 0;
      }

      .chat-box::-webkit-scrollbar {
        width: 8px;
      }

      .chat-box::-webkit-scrollbar-track {
        background: oklch(0.18 0.01 264);
        border-radius: 4px;
      }

      .chat-box::-webkit-scrollbar-thumb {
        background: oklch(0.45 0.15 264);
        border-radius: 4px;
      }

      .message {
        max-width: 70%;
        padding: 12px 16px;
        border-radius: 12px;
        margin-bottom: 12px;
        word-wrap: break-word;
        font-size: 14px;
      }

      .message-sent {
        background: oklch(0.45 0.15 264);
        color: oklch(0.98 0 0);
        margin-left: auto;
        border-bottom-right-radius: 4px;
      }

      .message-received {
        background: oklch(0.18 0.01 264);
        color: oklch(0.98 0 0);
        border: 1px solid oklch(0.25 0.01 264);
        margin-right: auto;
        border-bottom-left-radius: 4px;
        display: flex;
        align-items: flex-start;
        gap: 8px;
      }

      .avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        flex-shrink: 0;
      }

      .avatar-placeholder {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: oklch(0.25 0.01 264);
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
      }

      .avatar-icon {
        width: 18px;
        height: 18px;
        stroke: oklch(0.65 0.01 264);
        stroke-width: 2;
        fill: none;
      }

      .typing-indicator {
        font-size: 13px;
        color: oklch(0.65 0.01 264);
        font-style: italic;
        padding: 8px 0;
        min-height: 30px;
      }

      .active-chat-info {
        background: oklch(0.25 0.02 264);
        padding: 12px 16px;
        border-radius: 8px;
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        border: 1px solid oklch(0.25 0.01 264);
      }

      .active-chat-name {
        font-weight: 600;
        color: oklch(0.55 0.12 220);
        display: flex;
        align-items: center;
        gap: 6px;
      }

      /* Grid Layout */
      .grid-2 {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
      }

      /* Responsive */
      @media (max-width: 768px) {
        body {
          padding: 12px;
        }

        .page-header {
          padding: 20px;
        }

        .page-header h1 {
          font-size: 22px;
        }

        .section {
          padding: 16px;
        }

        .chat-box {
          height: 300px;
        }

        .message {
          max-width: 85%;
        }

        .grid-2 {
          grid-template-columns: 1fr;
        }
      }

      @media (max-width: 480px) {
        .page-header h1 {
          font-size: 20px;
        }

        .item-meta {
          flex-direction: column;
          gap: 4px;
        }

        .btn {
          width: 100%;
          justify-content: center;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="page-header">
        <h1>Socket.IO Test Client</h1>
        <p>Chat, Jobs & Applications Management</p>
      </div>

      <!-- Connection Section -->
      <div class="section">
        <h2 class="section-title">
          <svg class="section-icon" viewBox="0 0 24 24">
            <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"></path>
          </svg>
          Connection Settings
        </h2>

        <div class="form-group">
          <label class="form-label">JWT Token</label>
          <input
            type="text"
            id="token"
            class="form-input"
            placeholder="Paste your JWT token here"
          />
        </div>

        <div class="form-group">
          <label class="form-label">Your Role</label>
          <select id="role" class="form-select" onchange="toggleSections()">
            <option value="HR">HR / Admin</option>
            <option value="User">User</option>
          </select>
        </div>

        <div style="display: flex; gap: 12px; flex-wrap: wrap">
          <button class="btn btn-primary" onclick="connectSocket()">
            <svg class="btn-icon" viewBox="0 0 24 24">
              <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"></path>
            </svg>
            Connect
          </button>
          <button class="btn btn-secondary" onclick="disconnectSocket()">
            <svg class="btn-icon" viewBox="0 0 24 24">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
            Disconnect
          </button>
        </div>
      </div>

      <!-- Status -->
      <div id="status"></div>

      <!-- HR Section -->
      <div id="hrSection" class="section">
        <h2 class="section-title">
          <svg class="section-icon" viewBox="0 0 24 24">
            <line x1="12" y1="20" x2="12" y2="10"></line>
            <line x1="18" y1="20" x2="18" y2="4"></line>
            <line x1="6" y1="20" x2="6" y2="16"></line>
          </svg>
          HR Dashboard
        </h2>

        <div style="margin-bottom: 24px">
          <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 12px">
            Step 1: View Company Jobs
          </h3>
          <div class="form-group">
            <label class="form-label">Company ID</label>
            <input
              type="text"
              id="companyId"
              class="form-input"
              placeholder="Enter your company ID"
            />
          </div>
          <button class="btn btn-success" onclick="getCompanyJobs()">
            Get Jobs
          </button>
          <div id="jobsList" class="list-box"></div>
        </div>

        <div>
          <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 12px">
            Step 2: View Job Applicants
          </h3>
          <div class="form-group">
            <label class="form-label">Job ID</label>
            <input
              type="text"
              id="jobId"
              class="form-input"
              placeholder="Select a job above or enter job ID"
            />
          </div>
          <button class="btn btn-success" onclick="getJobApplicants()">
            Get Applicants
          </button>
          <div id="applicantsList" class="list-box"></div>
        </div>
      </div>

      <!-- User Section -->
      <div id="userSection" class="section hidden">
        <h2 class="section-title">
          <svg class="section-icon" viewBox="0 0 24 24">
            <path
              d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"
            ></path>
            <polyline points="14 2 14 8 20 8"></polyline>
            <line x1="16" y1="13" x2="8" y2="13"></line>
            <line x1="16" y1="17" x2="8" y2="17"></line>
            <polyline points="10 9 9 9 8 9"></polyline>
          </svg>
          My Applications
        </h2>
        <button class="btn btn-success" onclick="getMyApplications()">
          View My Applications
        </button>
        <div id="myApplicationsList" class="list-box"></div>
      </div>

      <!-- Chat Section -->
      <div class="section">
        <h2 class="section-title">
          <svg class="section-icon" viewBox="0 0 24 24">
            <path
              d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"
            ></path>
          </svg>
          Chat
        </h2>

        <div id="activeChatInfo" class="active-chat-info" style="display: none">
          <div class="active-chat-name">
            <svg class="btn-icon" viewBox="0 0 24 24">
              <path
                d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"
              ></path>
            </svg>
            <span id="activeChatName">None</span>
          </div>
          <button class="btn btn-secondary btn-small" onclick="clearChat()">
            Clear
          </button>
        </div>

        <div class="form-group">
          <label class="form-label">Receiver ID</label>
          <input
            type="text"
            id="receiverId"
            class="form-input"
            placeholder="Click on a user from above or enter manually"
            readonly
          />
        </div>

        <div id="chatBox" class="chat-box"></div>
        <div id="typingIndicator" class="typing-indicator"></div>

        <div style="display: flex; gap: 12px">
          <input
            type="text"
            id="messageInput"
            class="form-input"
            placeholder="Type a message..."
            onkeypress="handleEnterKey(event)"
            style="flex: 1"
          />
          <button class="btn btn-primary" onclick="sendMessage()">
            <svg class="btn-icon" viewBox="0 0 24 24">
              <line x1="22" y1="2" x2="11" y2="13"></line>
              <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
            </svg>
            Send
          </button>
        </div>
      </div>
    </div>

    <script>
      let socket = null;
      let currentReceiverId = null;
      let currentReceiverName = null;

      function toggleSections() {
        const role = document.getElementById('role').value;
        const hrSection = document.getElementById('hrSection');
        const userSection = document.getElementById('userSection');

        if (role === 'HR') {
          hrSection.classList.remove('hidden');
          userSection.classList.add('hidden');
        } else {
          hrSection.classList.add('hidden');
          userSection.classList.remove('hidden');
        }
      }

      function connectSocket() {
        const token = document.getElementById('token').value;
        if (!token) {
          alert('Please enter your JWT token');
          return;
        }

        socket = io({
          auth: { token: token },
          transports: ['websocket', 'polling'],
        });

        socket.on('connect', () => {
          showStatus('Connected to server', 'success');
        });

        socket.on('companyJobs', (data) => {
          displayJobs(data);
        });

        socket.on('jobApplicants', (data) => {
          displayApplicants(data);
        });

        socket.on('myApplications', (data) => {
          displayMyApplications(data);
        });

        socket.on('receiveMessage', (data) => {
          if (!currentReceiverId || currentReceiverId === data.senderId) {
            setActiveChat(data.senderId, data.senderName);
          }
          addMessageToChat(
            `${data.senderName}: ${data.message}`,
            'received',
            data.senderProfilePic,
          );
          document.getElementById('typingIndicator').innerHTML = '';
        });

        socket.on('userTyping', ({ userId }) => {
          if (currentReceiverId === userId) {
            document.getElementById('typingIndicator').innerHTML =
              `${currentReceiverName || 'User'} is typing...`;
          }
        });

        socket.on('userStoppedTyping', () => {
          document.getElementById('typingIndicator').innerHTML = '';
        });

        socket.on('error', (error) => {
          showStatus(`Error: ${error.message}`, 'error');
        });

        socket.on('connect_error', (error) => {
          showStatus(`Connection Error: ${error.message}`, 'error');
        });

        socket.on('disconnect', () => {
          showStatus('Disconnected from server', 'error');
        });
      }

      function disconnectSocket() {
        if (socket) {
          socket.disconnect();
          socket = null;
        }
      }

      function showStatus(message, type) {
        const statusEl = document.getElementById('status');
        const icon =
          type === 'success'
            ? '<svg class="status-icon" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"></polyline></svg>'
            : '<svg class="status-icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>';

        statusEl.innerHTML = `<div class="status-box status-${type}">${icon}${message}</div>`;
      }

      function setActiveChat(userId, userName) {
        currentReceiverId = userId;
        currentReceiverName = userName;
        document.getElementById('receiverId').value = userId;
        document.getElementById('activeChatInfo').style.display = 'flex';
        document.getElementById('activeChatName').textContent =
          userName || userId;
        loadChatHistory(userId);
      }

      async function loadChatHistory(userId) {
        const token = document.getElementById('token').value;
        const chatBox = document.getElementById('chatBox');
        chatBox.innerHTML =
          '<p style="text-align: center; color: oklch(0.98 0 0);">Loading history...</p>';

        try {
          const response = await fetch(`/api/v1/chat/${userId}?limit=50`, {
            headers: { Authorization: `Bearer ${token}` },
          });

          const result = await response.json();

          if (response.ok) {
            chatBox.innerHTML = '';
            const messages = result.data.messages.reverse();

            messages.forEach((msg) => {
              const isMe = msg.senderId._id !== userId;
              const type = isMe ? 'sent' : 'received';
              const senderName = isMe
                ? 'You'
                : `${msg.senderId.firstName} ${msg.senderId.lastName}`;
              const profilePic = msg.senderId.profilePic?.secure_url || null;

              addMessageToChat(
                `${senderName}: ${msg.message}`,
                type,
                profilePic,
              );
            });

            if (messages.length === 0) {
              chatBox.innerHTML =
                '<p style="text-align: center; color: oklch(0.98 0 0); padding: 20px;">No messages yet. Start the conversation!</p>';
            }
          } else {
            chatBox.innerHTML = `<p style="color: oklch(0.55 0.22 25);">Failed to load history</p>`;
          }
        } catch (error) {
          chatBox.innerHTML =
            '<p style="color: oklch(0.55 0.22 25);">Error loading history</p>';
        }
      }

      function clearChat() {
        currentReceiverId = null;
        currentReceiverName = null;
        document.getElementById('receiverId').value = '';
        document.getElementById('activeChatInfo').style.display = 'none';
        document.getElementById('chatBox').innerHTML = '';
      }

      function handleEnterKey(event) {
        if (event.key === 'Enter') {
          sendMessage();
        }
      }

      function getCompanyJobs() {
        const companyId = document.getElementById('companyId').value;
        if (!socket || !companyId) {
          alert('Please connect and enter a company ID');
          return;
        }
        socket.emit('getCompanyJobs', { companyId });
      }

      function displayJobs(data) {
        const container = document.getElementById('jobsList');
        if (data.totalJobs === 0) {
          container.innerHTML = '<p>No jobs found for this company.</p>';
          return;
        }

        let html = `<p style="margin-bottom: 16px; font-weight: 600; color: oklch(0.98 0 0);">Total Jobs: ${data.totalJobs}</p>`;

        data.jobs.forEach((job, index) => {
          html += `
          <div class="item-card">
            <div class="item-title">${index + 1}. ${job.jobTitle}</div>
            <div class="item-meta">
              <span class="meta-item">
                <svg class="meta-icon" viewBox="0 0 24 24"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
                ${job.jobLocation}
              </span>
              <span class="meta-item">
                <svg class="meta-icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                ${job.workingTime}
              </span>
              <span class="meta-item">
                <svg class="meta-icon" viewBox="0 0 24 24"><path d="M12 20v-6M6 20V10M18 20V4"></path></svg>
                ${job.seniorityLevel}
              </span>
            </div>
            <div style="margin-top: 8px; font-size: 13px; color: oklch(0.65 0.01 264);">Posted: ${new Date(job.createdAt).toLocaleDateString()}</div>
            <button class="btn btn-secondary btn-small" style="margin-top: 8px;" onclick="selectJob('${job.jobId}')">View Applicants</button>
          </div>
        `;
        });

        container.innerHTML = html;
      }

      function selectJob(jobId) {
        document.getElementById('jobId').value = jobId;
        getJobApplicants();
      }

      function getJobApplicants() {
        const jobId = document.getElementById('jobId').value;
        if (!socket || !jobId) {
          alert('Please connect and enter a job ID');
          return;
        }
        socket.emit('getJobApplicants', { jobId });
      }

      function displayApplicants(data) {
        const container = document.getElementById('applicantsList');
        if (data.totalApplicants === 0) {
          container.innerHTML = '<p>No applicants for this job yet.</p>';
          return;
        }

        let html = `
        <h4 style="margin-bottom: 8px; color: oklch(0.98 0 0);">${data.jobTitle}</h4>
        <p style="margin-bottom: 16px; font-weight: 600; color: oklch(0.98 0 0);">Total Applicants: ${data.totalApplicants}</p>
      `;

        data.applicants.forEach((app, index) => {
          const statusClass =
            {
              pending: 'badge-pending',
              accepted: 'badge-accepted',
              rejected: 'badge-rejected',
              viewed: 'badge-viewed',
            }[app.status] || 'badge-pending';

          html += `
          <div class="item-card">
            <div class="item-title">${index + 1}. ${app.applicant.name}</div>
            <div class="item-meta">
              <span class="meta-item">
                <svg class="meta-icon" viewBox="0 0 24 24"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
                ${app.applicant.email}
              </span>
            </div>
            <span class="status-badge ${statusClass}">${app.status}</span>
            <div style="margin-top: 8px; font-size: 13px; color: oklch(0.65 0.01 264);">Applied: ${new Date(app.appliedAt).toLocaleString()}</div>
            <div style="margin-top: 12px; display: flex; gap: 8px; flex-wrap: wrap;">
              <a href="${app.cvUrl}" target="_blank" class="btn btn-secondary btn-small">
                <svg class="btn-icon" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>
                View CV
              </a>
              <button class="btn btn-primary btn-small" onclick="startChatWith('${app.applicant.id}', '${app.applicant.name}')">
                <svg class="btn-icon" viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
                Chat
              </button>
            </div>
          </div>
        `;
        });

        container.innerHTML = html;
      }

      function getMyApplications() {
        if (!socket) {
          alert('Please connect first');
          return;
        }
        socket.emit('getMyApplications');
      }

      function displayMyApplications(data) {
        const container = document.getElementById('myApplicationsList');
        if (data.totalApplications === 0) {
          container.innerHTML = '<p>You have not applied to any jobs yet.</p>';
          return;
        }

        let html = `<p style="margin-bottom: 16px; font-weight: 600; color: oklch(0.98 0 0);">Total Applications: ${data.totalApplications}</p>`;

        data.applications.forEach((app, index) => {
          const statusClass =
            {
              pending: 'badge-pending',
              accepted: 'badge-accepted',
              rejected: 'badge-rejected',
              viewed: 'badge-viewed',
            }[app.status] || 'badge-pending';

          html += `
          <div class="item-card">
            <div class="item-title">${index + 1}. ${app.job.title}</div>
            <div class="item-meta">
              <span class="meta-item">
                <svg class="meta-icon" viewBox="0 0 24 24"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
                ${app.job.location}
              </span>
            </div>
            <span class="status-badge ${statusClass}">${app.status}</span>
            <div style="margin-top: 8px; font-size: 13px; color: oklch(0.65 0.01 264);">Applied: ${new Date(app.appliedAt).toLocaleString()}</div>
            <a href="${app.cvUrl}" target="_blank" class="btn btn-secondary btn-small" style="margin-top: 12px;">
              <svg class="btn-icon" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>
              View My CV
            </a>
          </div>
        `;
        });

        container.innerHTML = html;
      }

      function startChatWith(userId, userName) {
        setActiveChat(userId, userName);
        document.getElementById('messageInput').focus();
      }

      function sendMessage() {
        const receiverId =
          currentReceiverId || document.getElementById('receiverId').value;
        const message = document.getElementById('messageInput').value;

        if (!socket || !receiverId || !message) {
          alert('Please connect, select a user, and enter a message');
          return;
        }

        socket.emit('sendMessage', { receiverId, message });
        addMessageToChat(`You: ${message}`, 'sent');
        document.getElementById('messageInput').value = '';
      }

      function escapeHtml(str) {
        return String(str)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;');
      }

      function addMessageToChat(text, type, profilePic = null) {
        const chatBox = document.getElementById('chatBox');
        const messageDiv = document.createElement('div');
        messageDiv.className = `message message-${type}`;

        if (type === 'received') {
          if (profilePic) {
            messageDiv.innerHTML = `<img src="${profilePic}" class="avatar" alt="Avatar">${escapeHtml(text)}`;
          } else {
            messageDiv.innerHTML = `
            <div class="avatar-placeholder">
              <svg class="avatar-icon" viewBox="0 0 24 24">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
              </svg>
            </div>
            ${escapeHtml(text)}
          `;
          }
        } else {
          messageDiv.textContent = text;
        }

        chatBox.appendChild(messageDiv);
        chatBox.scrollTop = chatBox.scrollHeight;
      }

      // Typing indicator
      document.getElementById('messageInput').addEventListener('input', (e) => {
        const receiverId = document.getElementById('receiverId').value;
        if (socket && receiverId) {
          if (e.target.value.length > 0) {
            socket.emit('typing', { receiverId });
          } else {
            socket.emit('stopTyping', { receiverId });
          }
        }
      });

      // Initialize sections visibility
      toggleSections();
    </script>
  </body>
</html>
